/**
 * å›½å†…ç”¨æˆ·è®¤è¯ API (App Routerç‰ˆ)
 * ç®€åŒ–åçš„ç‰ˆæœ¬ï¼šä»…å¤„ç†ç™»å½•è®¤è¯
 *
 * æ”¯æŒçš„æ“ä½œ:
 * - action=signup: ç”¨æˆ·æ³¨å†Œ
 * - action=login: ç”¨æˆ·ç™»å½•
 *
 * è°ƒç”¨æ–¹æ³•:
 * POST /api/auth
 * {
 *   "action": "login|signup",
 *   "email": "user@example.com",
 *   "password": "password123"
 * }
 */

import type { NextRequest } from "next/server";
import { NextResponse } from "next/server";
import { loginUser, signupUser } from "@/lib/cloudbase-service";

/**
 * POST /api/auth
 */
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { email, password, action = "login" } = body;

    console.log("ğŸ“¨ [/api/auth] æ”¶åˆ°è¯·æ±‚ï¼Œaction:", action, "email:", email);

    if (!email || !password) {
      return NextResponse.json(
        {
          success: false,
          message: "è¯·æä¾›é‚®ç®±å’Œå¯†ç ",
        },
        { status: 400 }
      );
    }

    if (action === "login") {
      // ç™»å½•
      console.log("ğŸ” [/api/auth] å¤„ç†ç™»å½•è¯·æ±‚");
      const result = await loginUser(email, password);

      if (!result.success) {
        return NextResponse.json(
          {
            success: false,
            message: result.error || "ç™»å½•å¤±è´¥",
          },
          { status: 401 }
        );
      }

      return NextResponse.json({
        success: true,
        user: {
          id: result.userId,
          email: result.email,
          name: result.name,
        },
        token: result.token,
      });
    } else if (action === "signup") {
      // æ³¨å†Œ
      console.log("ğŸ“ [/api/auth] å¤„ç†æ³¨å†Œè¯·æ±‚");
      const result = await signupUser(email, password);

      if (!result.success) {
        return NextResponse.json(
          {
            success: false,
            message: result.error || "æ³¨å†Œå¤±è´¥",
          },
          { status: 400 }
        );
      }

      return NextResponse.json({
        success: true,
        user: {
          id: result.userId,
          email: email,
          name: email.split("@")[0],
        },
        token: result.token,
      });
    } else {
      return NextResponse.json(
        {
          success: false,
          message: "æœªçŸ¥çš„ action",
        },
        { status: 400 }
      );
    }
  } catch (error: any) {
    console.error("âŒ [/api/auth] å¼‚å¸¸:", error);
    return NextResponse.json(
      {
        success: false,
        message: error.message || "æœåŠ¡å™¨é”™è¯¯",
      },
      { status: 500 }
    );
  }
}

/**
 * è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯
 */
async function getWechatUserInfo(code: string) {
  try {
    const appId = process.env.NEXT_PUBLIC_WECHAT_APP_ID;
    const appSecret = process.env.WECHAT_APP_SECRET;

    if (!appId || !appSecret) {
      throw new Error("å¾®ä¿¡åº”ç”¨é…ç½®ç¼ºå¤±");
    }

    // ç¬¬ä¸€æ­¥ï¼šä½¿ç”¨æˆæƒç æ¢å– access_token
    const tokenUrl = `https://api.weixin.qq.com/sns/oauth2/access_token?appid=${appId}&secret=${appSecret}&code=${code}&grant_type=authorization_code`;

    const tokenResponse = await fetch(tokenUrl);
    const tokenData = await tokenResponse.json();

    if (tokenData.errcode) {
      console.error("å¾®ä¿¡è·å–access_tokenå¤±è´¥:", tokenData);
      return null;
    }

    const { access_token, openid, unionid } = tokenData;

    // ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ access_token è·å–ç”¨æˆ·ä¿¡æ¯
    const userUrl = `https://api.weixin.qq.com/sns/userinfo?access_token=${access_token}&openid=${openid}&lang=zh_CN`;

    const userResponse = await fetch(userUrl);
    const userData = await userResponse.json();

    if (userData.errcode) {
      console.error("å¾®ä¿¡è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:", userData);
      return null;
    }

    return {
      openid: userData.openid,
      unionid: userData.unionid || unionid,
      nickname: userData.nickname,
      sex: userData.sex,
      province: userData.province,
      city: userData.city,
      country: userData.country,
      headimgurl: userData.headimgurl,
      privilege: userData.privilege,
    };
  } catch (error) {
    console.error("è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯æ—¶å‡ºé”™:", error);
    return null;
  }
}

/**
 * POST /api/auth
 */
export async function POST(request: NextRequest) {
  try {
    // è°ƒè¯•ï¼šè®°å½•åŸå§‹è¯·æ±‚ä½“
    const rawBody = await request.text();
    console.log("ğŸ” Raw request body:", rawBody);

    let body;
    try {
      body = JSON.parse(rawBody);
    } catch (parseError) {
      console.error("âŒ JSON parse error:", parseError);
      return NextResponse.json(
        {
          success: false,
          message: "Invalid JSON format",
        },
        { status: 400 }
      );
    }

    const { email, password, action = "login", code } = body;

    // åœ¨è¯·æ±‚å¤„ç†æ—¶åˆå§‹åŒ– CloudBaseï¼Œé¿å…å…¨å±€åˆå§‹åŒ–é—®é¢˜
    let app: any;
    let auth: any;
    let db: any;

    try {
      // ä½¿ç”¨ Node.js é€‚é…å™¨
      cloudbase.useAdapters(adapter);

      // åˆå§‹åŒ– CloudBase App å®ä¾‹
      app = cloudbase.init({
        env:
          process.env.NEXT_PUBLIC_WECHAT_CLOUDBASE_ID ||
          "multigpt-6g9pqxiz52974a7c",
        appSecret: process.env.CLOUDBASE_SECRET_KEY as string,
        appSign: process.env.CLOUDBASE_SECRET_KEY as string,
      });

      auth = app.auth();
      db = app.mysql();

      console.log("âœ… CloudBase åˆå§‹åŒ–æˆåŠŸ");
    } catch (initError: any) {
      console.error("âŒ CloudBase åˆå§‹åŒ–å¤±è´¥:", initError);
      return NextResponse.json(
        {
          success: false,
          message: "CloudBase åˆå§‹åŒ–å¤±è´¥: " + initError.message,
        },
        { status: 500 }
      );
    }

    if (action === "signup") {
      // ============ æ³¨å†Œé€»è¾‘ ============
      try {
        console.log(`ğŸ“ [Signup] å¤„ç†é‚®ç®±: ${email}`);

        if (!email || !password) {
          return NextResponse.json(
            {
              success: false,
              message: "è¯·æä¾›é‚®ç®±å’Œå¯†ç ",
            },
            { status: 400 }
          );
        }

        // ä½¿ç”¨ CloudBase å†…ç½®æ³¨å†Œ
        const loginState = await auth.signUp({
          email: email,
          password: password,
          name: email.split("@")[0], // ä½¿ç”¨é‚®ç®±å‰ç¼€ä½œä¸ºç”¨æˆ·å
        });

        console.log(`âœ… [Signup] æ³¨å†ŒæˆåŠŸ: ${email}`);

        // è·å–ç”¨æˆ·ä¿¡æ¯
        const user = auth.currentUser;
        if (!user) {
          return NextResponse.json(
            {
              success: false,
              message: "æ³¨å†ŒæˆåŠŸä½†è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥",
            },
            { status: 500 }
          );
        }

        // è·å–è®¿é—®ä»¤ç‰Œ
        let accessToken: string;
        try {
          const tokenResult = await auth.getAccessToken();
          accessToken = tokenResult.accessToken;
          console.log(
            `ğŸ”‘ [Signup] è·å–åˆ°è®¿é—®ä»¤ç‰Œ: ${accessToken?.substring(0, 20)}...`
          );
        } catch (tokenError) {
          console.error("âŒ [Signup] è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥:", tokenError);
          return NextResponse.json(
            {
              success: false,
              message: "æ³¨å†ŒæˆåŠŸä½†è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥",
            },
            { status: 500 }
          );
        }

        // åœ¨ user_profiles è¡¨ä¸­åˆ›å»ºç”¨æˆ·è®°å½•
        const userProfile = {
          _id: user.uid,
          _openid: user.uid,
          user_id: email,
          email: email,
          full_name: user.name || email.split("@")[0],
          avatar_url: (user as any).picture || null,
          subscription_plan: "free",
          subscription_status: "active",
          createdAt: Date.now(),
          updatedAt: Date.now(),
          createBy: "system",
          updateBy: "system",
          _sort: 0,
          owner: email,
        };

        const { error: insertError } = await db
          .from("user_profiles")
          .insert(userProfile);
        if (insertError) {
          console.error("âŒ æ’å…¥ç”¨æˆ·æ¡£æ¡ˆé”™è¯¯:", insertError);
          // ä¸è¿”å›é”™è¯¯ï¼Œç»§ç»­å¤„ç†
        }

        return NextResponse.json(
          {
            success: true,
            message: "æ³¨å†ŒæˆåŠŸ",
            user: {
              id: user.uid,
              userId: user.uid,
              email: user.email,
              name: user.name,
              avatar: (user as any).picture,
              pro: false,
              region: "china",
            },
            token: accessToken,
          },
          { status: 200 }
        );
      } catch (error: any) {
        console.error("âŒ [Signup] æ³¨å†Œé”™è¯¯:", error);
        return NextResponse.json(
          {
            success: false,
            message: error.message || "æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•",
          },
          { status: 400 }
        );
      }
    } else if (action === "login") {
      // ============ ç™»å½•é€»è¾‘ ============
      try {
        console.log(`ğŸ” [Login] å¤„ç†é‚®ç®±: ${email}`);

        if (!email || !password) {
          return NextResponse.json(
            {
              success: false,
              message: "è¯·æä¾›é‚®ç®±å’Œå¯†ç ",
            },
            { status: 400 }
          );
        }

        // ä½¿ç”¨ CloudBase å†…ç½®ç™»å½•
        const loginState = await auth.signIn({
          username: email,
          password: password,
        });

        console.log(`âœ… [Login] ç™»å½•æˆåŠŸ: ${email}`);

        // è·å–ç”¨æˆ·ä¿¡æ¯
        const user = auth.currentUser;
        if (!user) {
          return NextResponse.json(
            {
              success: false,
              message: "ç™»å½•æˆåŠŸä½†è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥",
            },
            { status: 500 }
          );
        }

        // è·å–è®¿é—®ä»¤ç‰Œ
        let accessToken: string;
        try {
          const tokenResult = await auth.getAccessToken();
          accessToken = tokenResult.accessToken;
          console.log(
            `ğŸ”‘ [Login] è·å–åˆ°è®¿é—®ä»¤ç‰Œ: ${accessToken?.substring(0, 20)}...`
          );
        } catch (tokenError) {
          console.error("âŒ [Login] è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥:", tokenError);
          return NextResponse.json(
            {
              success: false,
              message: "ç™»å½•æˆåŠŸä½†è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥",
            },
            { status: 500 }
          );
        }

        return NextResponse.json(
          {
            success: true,
            message: "ç™»å½•æˆåŠŸ",
            user: {
              id: user.uid,
              userId: user.uid,
              email: user.email,
              name: user.name,
              avatar: (user as any).picture,
              pro: false,
              region: "china",
            },
            token: accessToken,
          },
          { status: 200 }
        );
      } catch (error: any) {
        console.error("âŒ [Login] ç™»å½•é”™è¯¯:", error);
        return NextResponse.json(
          {
            success: false,
            message: error.message || "é‚®ç®±æˆ–å¯†ç é”™è¯¯",
          },
          { status: 400 }
        );
      }
    } else if (action === "refresh") {
      // ============ Tokenåˆ·æ–°é€»è¾‘ ============
      try {
        console.log(`ğŸ”„ [Refresh] åˆ·æ–°Token`);

        // æ£€æŸ¥å½“å‰ç™»å½•çŠ¶æ€
        const loginState = auth.hasLoginState();
        if (!loginState) {
          return NextResponse.json(
            {
              success: false,
              message: "ç”¨æˆ·æœªç™»å½•",
            },
            { status: 401 }
          );
        }

        // è·å–æ–°çš„è®¿é—®ä»¤ç‰Œ
        const { accessToken } = await auth.getAccessToken();

        console.log(`âœ… [Refresh] Tokenå·²åˆ·æ–°`);

        return NextResponse.json(
          {
            success: true,
            message: "Tokenåˆ·æ–°æˆåŠŸ",
            token: accessToken,
          },
          { status: 200 }
        );
      } catch (error: any) {
        console.error("âŒ [Refresh] Tokenåˆ·æ–°é”™è¯¯:", error);
        return NextResponse.json(
          {
            success: false,
            message: error.message || "Tokenåˆ·æ–°å¤±è´¥",
          },
          { status: 400 }
        );
      }
    } else if (action === "login_wechat") {
      // ============ å¾®ä¿¡ç™»å½•é€»è¾‘ ============
      try {
        if (!code) {
          return NextResponse.json(
            {
              success: false,
              message: "ç¼ºå°‘å¾®ä¿¡æˆæƒç ",
            },
            { status: 400 }
          );
        }

        console.log(
          `ğŸ” [WeChat Login] å¤„ç†æˆæƒç : ${code.substring(0, 10)}...`
        );

        // ä½¿ç”¨å¾®ä¿¡æˆæƒç è·å–ç”¨æˆ·ä¿¡æ¯
        const wechatUserInfo = await getWechatUserInfo(code);

        if (!wechatUserInfo) {
          return NextResponse.json(
            {
              success: false,
              message: "è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯å¤±è´¥",
            },
            { status: 400 }
          );
        }

        // ä½¿ç”¨ CloudBase å¾®ä¿¡ç™»å½•
        const loginState = await (auth as any).signInWithOpenId({
          useWxCloud: true, // ä½¿ç”¨å¾®ä¿¡äº‘å¼€å‘æ¨¡å¼
        });

        console.log(`âœ… [WeChat Login] ç™»å½•æˆåŠŸ: ${wechatUserInfo.nickname}`);

        // è·å–ç”¨æˆ·ä¿¡æ¯
        const user = auth.currentUser;
        if (!user) {
          return NextResponse.json(
            {
              success: false,
              message: "å¾®ä¿¡ç™»å½•æˆåŠŸä½†è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥",
            },
            { status: 500 }
          );
        }

        // è·å–è®¿é—®ä»¤ç‰Œ
        let accessToken: string;
        try {
          const tokenResult = await auth.getAccessToken();
          accessToken = tokenResult.accessToken;
          console.log(
            `ğŸ”‘ [WeChat Login] è·å–åˆ°è®¿é—®ä»¤ç‰Œ: ${accessToken?.substring(
              0,
              20
            )}...`
          );
        } catch (tokenError) {
          console.error("âŒ [WeChat Login] è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥:", tokenError);
          return NextResponse.json(
            {
              success: false,
              message: "å¾®ä¿¡ç™»å½•æˆåŠŸä½†è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥",
            },
            { status: 500 }
          );
        }

        // æ›´æ–°æˆ–åˆ›å»ºç”¨æˆ·æ¡£æ¡ˆ
        const userProfile = {
          _id: user.uid,
          _openid: user.uid,
          user_id: wechatUserInfo.openid,
          email: `${wechatUserInfo.openid}@wechat.local`,
          full_name: wechatUserInfo.nickname || "å¾®ä¿¡ç”¨æˆ·",
          avatar_url: wechatUserInfo.headimgurl,
          wechat_open_id: wechatUserInfo.openid,
          wechat_union_id: wechatUserInfo.unionid,
          subscription_plan: "free",
          subscription_status: "active",
          createdAt: Date.now(),
          updatedAt: Date.now(),
          createBy: "system",
          updateBy: "system",
          _sort: 0,
          owner: wechatUserInfo.openid,
        };

        // å…ˆå°è¯•æ›´æ–°ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ’å…¥
        const { error: upsertError } = await db
          .from("user_profiles")
          .upsert(userProfile);
        if (upsertError) {
          console.error("âŒ æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆé”™è¯¯:", upsertError);
        }

        return NextResponse.json(
          {
            success: true,
            message: "å¾®ä¿¡ç™»å½•æˆåŠŸ",
            user: {
              id: user.uid,
              userId: user.uid,
              email: userProfile.email,
              name: userProfile.full_name,
              avatar: userProfile.avatar_url,
              pro: false,
              region: "china",
            },
            token: accessToken,
          },
          { status: 200 }
        );
      } catch (error: any) {
        console.error("âŒ [WeChat Login] ç™»å½•é”™è¯¯:", error);
        return NextResponse.json(
          {
            success: false,
            message: error.message || "å¾®ä¿¡ç™»å½•å¤±è´¥",
          },
          { status: 400 }
        );
      }
    } else {
      return NextResponse.json(
        {
          success: false,
          message:
            "æ— æ•ˆçš„actionå‚æ•°ï¼Œè¯·ä½¿ç”¨ signup, login, refresh æˆ– login_wechat",
        },
        { status: 400 }
      );
    }
  } catch (error: any) {
    console.error("âŒ [API Error]:", error);
    return NextResponse.json(
      {
        success: false,
        message: error.message || "æœåŠ¡å™¨é”™è¯¯",
      },
      { status: 500 }
    );
  }
}
