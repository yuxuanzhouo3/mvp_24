# 登录流程测试指南

## 测试环境

- **开发服务器**: http://localhost:3000
- **网络访问**: http://192.168.253.1:3000

## 主要修复内容

✅ **已修复的问题**:

1. Middleware 认证重定向循环
2. 重复的用户状态检查
3. 登录后双重重定向
4. URL 参数丢失
5. 竞态条件

## 测试步骤

### 1️⃣ 基础登录测试

#### 测试场景 1: 未登录访问首页

**步骤**:

1. 清除浏览器 cookies 和 localStorage
2. 访问 http://localhost:3000
3. **预期结果**: 自动重定向到 `/auth` 登录页

#### 测试场景 2: 邮箱密码登录

**步骤**:

1. 在登录页输入邮箱和密码
2. 点击"登录"按钮
3. **预期结果**:
   - 显示"登录中..."
   - 登录成功后自动跳转到首页
   - 页面右上角显示用户头像和名称
   - **无重定向循环**

#### 测试场景 3: 已登录访问登录页

**步骤**:

1. 在已登录状态下访问 `/auth`
2. **预期结果**: 自动重定向到首页

### 2️⃣ OAuth 登录测试

#### 测试场景 4: Google OAuth 登录

**步骤**:

1. 清除登录状态
2. 访问 `/auth`
3. 点击"使用 Google 登录"按钮
4. 完成 Google 授权
5. **预期结果**:
   - 重定向到 `/auth/callback`
   - 显示"正在处理认证..."
   - 自动跳转到首页
   - **无错误消息**

### 3️⃣ 登出测试

#### 测试场景 5: 正常登出

**步骤**:

1. 在已登录状态下
2. 点击右上角用户菜单
3. 选择"登出"
4. **预期结果**:
   - 立即跳转到 `/auth` 登录页
   - 用户状态清除
   - 无法再访问受保护页面

### 4️⃣ URL 参数保留测试

#### 测试场景 6: Debug 模式参数保留

**步骤**:

1. 访问 `http://localhost:3000?debug=china`
2. 进行登录
3. 访问各个页面
4. **预期结果**:
   - URL 始终包含 `?debug=china` 参数
   - 页面右上角显示调试模式面板
   - 登出后重定向到 `/auth?debug=china`

### 5️⃣ 忘记密码流程测试

#### 测试场景 7: 重置密码

**步骤**:

1. 在登录页点击"忘记密码？"
2. 输入邮箱，点击"发送验证码"
3. 检查邮箱获取验证码
4. 输入验证码验证
5. 设置新密码
6. **预期结果**:
   - 收到验证码邮件
   - 验证成功后可设置新密码
   - 密码重置成功后返回登录页
   - 可使用新密码登录

### 6️⃣ 注册新用户测试

#### 测试场景 8: 邮箱注册

**步骤**:

1. 访问 `/auth?mode=signup`
2. 输入邮箱和密码
3. 点击"注册"
4. **预期结果**:
   - 显示"注册成功！请检查您的邮箱并点击确认链接。"
   - 收到确认邮件
   - 点击邮件中的链接确认账户

### 7️⃣ 路由保护测试

#### 测试场景 9: 未登录访问受保护页面

**步骤**:

1. 清除登录状态
2. 尝试直接访问:
   - `/settings`
   - `/profile`
   - `/payment`
3. **预期结果**:
   - 所有页面都重定向到 `/auth`
   - 登录后可正常访问

### 8️⃣ 性能和稳定性测试

#### 测试场景 10: 快速切换页面

**步骤**:

1. 登录后快速切换多个页面
2. 观察是否有重复请求
3. 打开开发者工具 Network 面板
4. **预期结果**:
   - 无重复的 API 请求
   - 页面切换流畅
   - 无控制台错误

#### 测试场景 11: 刷新页面

**步骤**:

1. 在已登录状态下刷新页面
2. 观察加载过程
3. **预期结果**:
   - 用户状态保持
   - 无重定向到登录页
   - 快速加载（< 1 秒显示用户信息）

## 检查点清单

### 控制台日志检查

打开浏览器开发者工具，检查以下日志：

✅ **正常日志**:

- `开始初始化用户状态...`
- `Auth state change: SIGNED_IN`
- `用户登录，设置基本信息`

❌ **错误日志**:

- 无 `跳过重复的登录事件` （表示有竞态条件）
- 无 `User state inconsistency` （表示状态不一致）
- 无 `Maximum update depth exceeded` （表示重渲染循环）

### Network 请求检查

检查 Network 面板：

✅ **正常行为**:

- 登录时只有一次 `signInWithPassword` 请求
- 初始化时只有一次 `getSession` 请求
- 用户资料最多加载两次（基本信息 + 完整资料）

❌ **异常行为**:

- 多次重复的认证请求
- 无限循环的 API 调用
- 超时的请求（> 10 秒）

### 页面行为检查

✅ **正常行为**:

- 登录后自动跳转到首页
- 登出后自动跳转到登录页
- 未登录访问首页自动跳转到登录页
- 已登录访问登录页自动跳转到首页

❌ **异常行为**:

- 页面闪烁或多次重定向
- 卡在"加载中..."状态
- 白屏或崩溃

## 常见问题排查

### 问题 1: 登录后一直显示"加载中..."

**可能原因**: user-context 初始化失败
**检查**:

1. 查看控制台是否有错误
2. 检查 Supabase 配置是否正确
3. 检查网络连接

### 问题 2: 重定向循环

**可能原因**: middleware 和前端重定向冲突
**检查**:

1. 确认 middleware.ts 没有认证重定向
2. 检查是否有多个 useEffect 触发重定向

### 问题 3: URL 参数丢失

**可能原因**: 跳转时未使用 buildUrl 函数
**检查**:

1. 搜索所有 `router.push` 和 `router.replace`
2. 确认都使用了 `buildUrl()`

### 问题 4: OAuth 登录失败

**可能原因**: 回调 URL 配置错误
**检查**:

1. Supabase Dashboard > Authentication > URL Configuration
2. 确认 Redirect URLs 包含 `http://localhost:3000/auth/callback`
3. 检查 Google OAuth 配置

## 测试通过标准

所有测试场景应满足：

- ✅ 无重定向循环
- ✅ 无控制台错误
- ✅ 无重复 API 请求
- ✅ 登录/登出流畅
- ✅ URL 参数保持
- ✅ 页面加载快速（< 2 秒）
- ✅ 用户体验良好

## 性能指标

- **首次加载时间**: < 2 秒
- **登录响应时间**: < 1 秒
- **页面切换时间**: < 500ms
- **用户状态初始化**: < 500ms

---

**测试环境**: 本地开发环境
**最后更新**: 2025-10-29
**修复版本**: v2.0 - 登录逻辑重构
