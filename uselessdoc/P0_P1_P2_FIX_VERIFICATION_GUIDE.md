# P0/P1/P2 ä¿®å¤éªŒè¯æŒ‡å—

## ğŸ”§ å·²ä¿®å¤çš„é—®é¢˜

1. **å¼‚æ­¥å‡½æ•°è°ƒç”¨ç¼ºå°‘ await** (`lib/client-auth.ts`)

   - é”™è¯¯: `getValidToken()` æ˜¯å¼‚æ­¥ä½†æ²¡æœ‰ awaitï¼Œå¯¼è‡´è¿”å› Promise è€Œä¸æ˜¯ token
   - ä¿®å¤: æ·»åŠ äº† `await`

2. **ç™»å½•ä¿å­˜é”™è¯¯å¤„ç†ä¸å®Œå–„** (`lib/auth/client.ts`)

   - é”™è¯¯: P0 ä¿å­˜å¤±è´¥æ—¶æ²¡æœ‰å¤‡ç”¨æ–¹æ¡ˆï¼Œå¯¼è‡´æ²¡æœ‰ token è¢«ä¿å­˜
   - ä¿®å¤: æ·»åŠ äº† try-catch å’Œå¤‡ç”¨é€»è¾‘

3. **æ—§æ ¼å¼ token é”®æ²¡æœ‰è¢«æ¸…ç†**
   - é”™è¯¯: æ—§çš„ `auth-token` é”®å¯èƒ½å¯¼è‡´ç³»ç»Ÿè¯»å–é”™è¯¯çš„ token
   - ä¿®å¤: æ·»åŠ äº† `initAuthStateManager()` æ¥æ¸…ç†æ—§é”®

## âœ… éªŒè¯æ­¥éª¤

### 1. æ¸…é™¤æµè§ˆå™¨æ•°æ®

```
æŒ‰ F12 â†’ Application â†’ Clear Storage â†’ Clear All
```

æˆ–è€…åœ¨æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
localStorage.clear();
sessionStorage.clear();
```

### 2. é‡æ–°ç™»å½•

1. è®¿é—®åº”ç”¨ä¸»é¡µ
2. ç‚¹å‡»ç™»å½•
3. è¾“å…¥é‚®ç®±å’Œå¯†ç 
4. è§‚å¯Ÿ localStorage ä¸­çš„æ•°æ®ï¼š
   ```javascript
   // åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
   const state = JSON.parse(localStorage.getItem("app-auth-state"));
   console.log("Auth State:", state);
   console.log("Tokenæ ¼å¼æ£€æŸ¥:", state?.accessToken?.split(".").length, "éƒ¨åˆ†");
   ```

**é¢„æœŸè¾“å‡º**:

```
Auth State: {
  accessToken: "eyJ...", // 3éƒ¨åˆ† JWT
  refreshToken: "eyJ...", // 3éƒ¨åˆ† JWT
  user: { id: "xxx", email: "test@example.com", ... },
  tokenMeta: { accessTokenExpiresIn: 3600, refreshTokenExpiresIn: 604800 },
  savedAt: 1234567890
}
Tokenæ ¼å¼æ£€æŸ¥: 3 éƒ¨åˆ†  âœ…
```

### 3. æµ‹è¯• AI å¯¹è¯åŠŸèƒ½

1. å®Œæˆç™»å½•
2. è½¬åˆ°ä¸»é¡µï¼ˆåŒ…å« AI å¯¹è¯åŠŸèƒ½çš„é¡µé¢ï¼‰
3. ç‚¹å‡»"æ–°å»ºå¯¹è¯"æˆ–"å‘é€æ¶ˆæ¯"
4. è§‚å¯Ÿç½‘ç»œè¯·æ±‚ï¼š
   - åº”è¯¥çœ‹åˆ° `POST /api/chat/sessions` è¿”å› 200
   - ä¸åº”è¯¥çœ‹åˆ° 401 Unauthorized é”™è¯¯

### 4. æ£€æŸ¥è°ƒè¯•ä¿¡æ¯

è®¿é—® `/debug` é¡µé¢æŸ¥çœ‹ç™»å½•æ­¥éª¤ï¼š

```
âœ… DEBUG_LOGIN_STEP = "3_auth_state_saved"  // P0 ä¿å­˜æˆåŠŸ
âœ… app-auth-state ä¸­æœ‰å®Œæ•´çš„ token å’Œç”¨æˆ·æ•°æ®
âŒ ä¸åº”è¯¥çœ‹åˆ° "3_token_saved_legacy" æˆ–é”™è¯¯ä¿¡æ¯
```

### 5. å®Œæ•´æµç¨‹æµ‹è¯•

**åœºæ™¯ A: æ–°ç”¨æˆ·ç™»å½•**

```
1. æ¸…é™¤æ‰€æœ‰ localStorage
2. è®¿é—®ç™»å½•é¡µé¢
3. è¾“å…¥å‡­è¯ç™»å½•
4. æ£€æŸ¥ app-auth-state æ˜¯å¦åŒ…å« 3 éƒ¨åˆ† JWT token âœ…
5. å‘é€ AI è¯·æ±‚ âœ…
6. æŸ¥çœ‹ä¼šè¯æ˜¯å¦åˆ›å»ºæˆåŠŸ âœ…
```

**åœºæ™¯ B: ç”¨æˆ·åˆ·æ–°é¡µé¢**

```
1. ç™»å½•ååˆ·æ–°é¡µé¢ï¼ˆF5ï¼‰
2. æ£€æŸ¥æ˜¯å¦çœ‹åˆ°ç”¨æˆ·ä¿¡æ¯ä¸”æ²¡æœ‰é—ªçƒ âœ…
3. ç«‹å³å°è¯•å‘é€ AI è¯·æ±‚ âœ…
4. åº”è¯¥èƒ½æ­£å¸¸å·¥ä½œ âœ…
```

**åœºæ™¯ C: è·¨æ ‡ç­¾é¡µåŒæ­¥**

```
1. ä¸€ä¸ªæ ‡ç­¾é¡µç™»å½•
2. æ‰“å¼€å¦ä¸€ä¸ªæ ‡ç­¾é¡µ
3. è§‚å¯Ÿæ˜¯å¦è‡ªåŠ¨åŒæ­¥ç™»å½•çŠ¶æ€ âœ…
4. ä¸¤ä¸ªæ ‡ç­¾é¡µéƒ½èƒ½å‘é€ AI è¯·æ±‚ âœ…
```

## ğŸ” å¸¸è§é—®é¢˜

### Q: ä»ç„¶çœ‹åˆ° "Token æ ¼å¼é”™è¯¯ï¼Œéƒ¨åˆ†æ•°: 1" é”™è¯¯

**A**:

1. ç¡®è®¤å·²æ¸…é™¤ localStorage
2. æ£€æŸ¥ç½‘ç»œè¯·æ±‚ï¼Œçœ‹ Authorization å¤´æ˜¯å¦æ­£ç¡®ï¼ˆ`Bearer eyJ...`ï¼‰
3. æ£€æŸ¥ app-auth-state ä¸­çš„ token æ˜¯å¦æ˜¯ 3 éƒ¨åˆ†çš„
4. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰å…¶ä»–é”™è¯¯

### Q: ç™»å½•åæ²¡æœ‰çœ‹åˆ° user ä¿¡æ¯

**A**:

1. æ£€æŸ¥ç™»å½•å“åº”æ˜¯å¦åŒ…å« `user` å­—æ®µ
2. æ£€æŸ¥ `/api/auth/login` è¿”å›çš„çŠ¶æ€ç ï¼ˆåº”è¯¥æ˜¯ 200ï¼‰
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—ä¸­ `DEBUG_LOGIN_STEP` çš„å€¼

### Q: å‘é€ AI è¯·æ±‚æ—¶è¿”å› 401

**A**:

1. æ£€æŸ¥ Authorization å¤´æ ¼å¼æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤ token æ˜¯ 3 éƒ¨åˆ† JWTï¼ˆä¸æ˜¯ `[object Promise]`ï¼‰
3. æ£€æŸ¥ token æ˜¯å¦è¿‡æœŸ
4. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ä¸­çš„ token éªŒè¯é”™è¯¯

## ğŸ“Š ä¿®å¤éªŒè¯æ¸…å•

- [ ] localStorage å·²æ¸…é™¤
- [ ] é‡æ–°ç™»å½•æˆåŠŸ
- [ ] app-auth-state ä¸­æœ‰å®Œæ•´çš„ token
- [ ] token æ˜¯ 3 éƒ¨åˆ†çš„ JWT æ ¼å¼
- [ ] æ²¡æœ‰çœ‹åˆ° "3_token_saved_legacy" æ—¥å¿—
- [ ] èƒ½å¤Ÿåˆ›å»ºæ–°çš„å¯¹è¯ä¼šè¯
- [ ] èƒ½å¤Ÿå‘é€ AI è¯·æ±‚
- [ ] åˆ·æ–°é¡µé¢åä»ç„¶ä¿æŒç™»å½•çŠ¶æ€
- [ ] æ–°å¼€æ ‡ç­¾é¡µè‡ªåŠ¨åŒæ­¥ç™»å½•çŠ¶æ€

## ğŸ†˜ å¦‚æœä»ç„¶æœ‰é—®é¢˜

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. å» Console æ ‡ç­¾å¹¶æ‰§è¡Œï¼š

   ```javascript
   // æ£€æŸ¥ localStorage
   console.log("app-auth-state:", localStorage.getItem("app-auth-state"));
   console.log("auth-token:", localStorage.getItem("auth-token"));

   // æ£€æŸ¥ token æ ¼å¼
   const state = JSON.parse(localStorage.getItem("app-auth-state"));
   const parts = state?.accessToken?.split(".") ?? [];
   console.log("Token éƒ¨åˆ†æ•°:", parts.length);
   console.log("Token å†…å®¹:", {
     header: parts[0]?.substring(0, 30),
     payload: atob(parts[1]?.replace(/-/g, "+").replace(/_/g, "/") || ""),
     signature: parts[2]?.substring(0, 30),
   });
   ```

3. æ£€æŸ¥ Network æ ‡ç­¾ï¼š
   - POST /api/auth/login æ˜¯å¦è¿”å› 200
   - Authorization å¤´æ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®
   - æŸ¥çœ‹å“åº”ä½“ä¸­çš„ token æ ¼å¼
4. æŠ¥å‘Šä»¥ä¸‹ä¿¡æ¯ï¼š
   - localStorage ä¸­ app-auth-state çš„å†…å®¹
   - Network æ ‡ç­¾ä¸­çš„é”™è¯¯è¯·æ±‚è¯¦æƒ…
   - æµè§ˆå™¨æ§åˆ¶å°çš„å®Œæ•´é”™è¯¯ä¿¡æ¯
