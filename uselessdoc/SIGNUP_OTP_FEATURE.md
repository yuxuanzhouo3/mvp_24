# 注册验证码功能说明

## 功能概述

为了提高安全性和验证邮箱真实性，注册流程现在需要邮箱验证码验证。

## 注册流程

### 旧流程（已废弃）

```
输入邮箱和密码 → 提交注册 → 收到确认邮件 → 点击链接激活
```

### 新流程（当前）

```
1. 输入邮箱和密码
2. 点击"发送验证码"
3. 查收邮箱获取验证码
4. 输入验证码
5. 点击"验证并注册"
6. 注册成功，自动登录
```

## 实现细节

### 状态管理

添加了以下状态变量：

```typescript
const [signupOtp, setSignupOtp] = useState(""); // 注册验证码
const [signupOtpSent, setSignupOtpSent] = useState(false); // 验证码是否已发送
const [signupStep, setSignupStep] = useState<"form" | "verify">("form"); // 注册步骤
```

### 注册步骤

#### 步骤 1: 填写表单并发送验证码

- 用户输入邮箱、密码和确认密码
- 点击"发送验证码"按钮
- 系统验证：
  - 两次密码是否一致
  - 密码长度是否至少 6 位
- 验证通过后发送验证码到邮箱
- 切换到验证步骤

#### 步骤 2: 验证并完成注册

- 用户输入收到的 6 位验证码
- 点击"验证并注册"按钮
- 系统验证：
  - 验证码是否正确
  - 验证码是否过期
- 验证通过后创建用户账户
- 自动登录并跳转到首页

### UI 变化

#### 表单状态

- **步骤 1（表单填写）**：
  - 显示邮箱、密码、确认密码输入框
  - 按钮文字："发送验证码"
- **步骤 2（验证码验证）**：
  - 邮箱、密码输入框禁用（灰色显示）
  - 显示验证码输入框
  - 显示"重新发送验证码"和"返回修改"按钮
  - 按钮文字："验证并注册"

#### 按钮状态

```typescript
{
  loading
    ? signupStep === "form"
      ? "发送中..." // 正在发送验证码
      : "验证中..." // 正在验证并注册
    : signupStep === "form"
    ? "发送验证码" // 等待发送
    : "验证并注册";
} // 等待验证
```

### 核心函数

#### handleSignUp()

两阶段处理注册：

```typescript
if (signupStep === "form") {
  // 第一步：验证表单并发送验证码
  // 1. 验证密码匹配和长度
  // 2. 调用 signInWithOtp 发送验证码
  // 3. 切换到验证步骤
}

if (signupStep === "verify") {
  // 第二步：验证验证码并完成注册
  // 1. 验证 OTP
  // 2. 创建用户账户（signUp）
  // 3. 自动登录
}
```

#### handleResendSignupOtp()

重新发送验证码：

```typescript
const handleResendSignupOtp = async () => {
  // 1. 调用 signInWithOtp 重新发送验证码
  // 2. 显示成功提示
  // 3. 用户可以输入新的验证码
};
```

### 用户交互

#### 重新发送验证码

- 用户点击"重新发送验证码"
- 系统发送新的验证码到邮箱
- 原验证码失效
- 用户输入新验证码继续注册

#### 返回修改

- 用户点击"返回修改"
- 返回到表单填写步骤
- 可以修改邮箱或密码
- 之前的验证码失效

## 安全性改进

1. **邮箱验证**：确保用户拥有邮箱的访问权限
2. **防止滥用**：需要验证码才能完成注册
3. **时效性**：验证码有时效限制（通常 5-10 分钟）
4. **一次性使用**：验证码验证后即失效

## 错误处理

### 常见错误提示

| 错误情况   | 提示信息                         |
| ---------- | -------------------------------- |
| 密码不一致 | "两次输入的密码不一致"           |
| 密码太短   | "密码长度至少为 6 位"            |
| 验证码为空 | "请输入验证码"                   |
| 验证码错误 | "验证码错误或已过期，请重新获取" |
| 发送失败   | "发送验证码失败，请稍后重试"     |
| 注册失败   | "注册失败，请稍后重试"           |

### 错误恢复

- **验证码错误**：用户可以重新输入或点击"重新发送"
- **验证码过期**：点击"重新发送验证码"获取新验证码
- **网络错误**：点击"重新发送验证码"重试
- **信息填写错误**：点击"返回修改"修改信息

## 测试场景

### 正常流程测试

1. 访问注册页面
2. 输入有效邮箱和密码
3. 点击"发送验证码"
4. 检查邮箱收到验证码
5. 输入正确的验证码
6. 点击"验证并注册"
7. 验证成功并自动登录

### 异常流程测试

#### 测试 1: 密码不匹配

- 输入不一致的密码
- 点击"发送验证码"
- 应显示："两次输入的密码不一致"

#### 测试 2: 验证码错误

- 完成步骤 1，收到验证码
- 输入错误的验证码
- 点击"验证并注册"
- 应显示："验证码错误或已过期，请重新获取"

#### 测试 3: 重新发送验证码

- 完成步骤 1
- 点击"重新发送验证码"
- 应显示："验证码已重新发送到您的邮箱。"
- 使用新验证码应该可以成功注册

#### 测试 4: 返回修改信息

- 完成步骤 1
- 点击"返回修改"
- 应返回到表单填写界面
- 可以修改邮箱和密码

#### 测试 5: 验证码过期

- 完成步骤 1
- 等待验证码过期（通常 10 分钟）
- 输入过期的验证码
- 应显示："验证码错误或已过期，请重新获取"

## 与登录流程的区别

### 登录验证码（已有功能）

- 目的：无密码登录
- 使用场景：用户忘记密码或选择验证码登录
- 流程：发送验证码 → 验证 → 直接登录

### 注册验证码（新功能）

- 目的：验证邮箱真实性
- 使用场景：新用户注册
- 流程：发送验证码 → 验证 → 创建账户 → 登录

## 代码位置

- **文件**: `app/auth/page.tsx`
- **状态定义**: 第 23-45 行
- **处理函数**: `handleSignUp()` 和 `handleResendSignupOtp()`
- **UI 组件**: TabsContent signup 部分

## 后续优化建议

1. **倒计时功能**：添加 60 秒倒计时，防止频繁发送验证码
2. **验证码长度提示**：显示"X/6"输入进度
3. **自动提交**：输入 6 位后自动提交验证
4. **邮箱格式验证**：在发送前验证邮箱格式
5. **错误次数限制**：限制验证码错误次数，超过后需重新发送

---

**添加时间**: 2025-10-29
**修改文件**: app/auth/page.tsx
**状态**: ✅ 已完成并测试
