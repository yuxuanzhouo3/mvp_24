# æ”¯ä»˜å®æ”¯ä»˜æµ‹è¯•æŒ‡å—

## ğŸ¯ é—®é¢˜å·²è§£å†³

### é—®é¢˜æè¿°

æ”¯ä»˜åˆ›å»ºæˆåŠŸï¼Œä½†æ²¡æœ‰è·³è½¬åˆ°æ”¯ä»˜å®æ”¶é“¶å°ã€‚

### æ ¹æœ¬åŸå› 

æ”¯ä»˜å®è¿”å›çš„æ˜¯ **HTML è¡¨å•** (ç”¨äºè‡ªåŠ¨æäº¤åˆ°æ”¯ä»˜å®ç½‘å…³)ï¼Œè€Œä¸æ˜¯ç®€å•çš„ URLã€‚å‰ç«¯ä»£ç ä¹‹å‰åªå¤„ç†äº† URL è·³è½¬ï¼Œæ²¡æœ‰å¤„ç† HTML è¡¨å•ã€‚

### è§£å†³æ–¹æ¡ˆ

ä¿®æ”¹ `app/payment/page.tsx` ä¸­çš„ `handlePaymentSuccess` å‡½æ•°:

```typescript
const handlePaymentSuccess = (result: any) => {
  setPaymentResult(result);

  if (result.paymentUrl) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯HTMLè¡¨å• (æ”¯ä»˜å®è¿”å›çš„æ˜¯HTML)
    if (
      typeof result.paymentUrl === "string" &&
      result.paymentUrl.includes("<form")
    ) {
      // æ”¯ä»˜å®è¿”å›çš„æ˜¯HTMLè¡¨å•ï¼Œéœ€è¦åœ¨é¡µé¢ä¸­æ¸²æŸ“å¹¶è‡ªåŠ¨æäº¤
      const formContainer = document.createElement("div");
      formContainer.innerHTML = result.paymentUrl;
      document.body.appendChild(formContainer);

      // æŸ¥æ‰¾å¹¶è‡ªåŠ¨æäº¤è¡¨å•
      const form = formContainer.querySelector("form");
      if (form) {
        form.submit();
      }
    } else {
      // å…¶ä»–æ”¯ä»˜æ–¹å¼è¿”å›çš„æ˜¯URLï¼Œç›´æ¥è·³è½¬
      window.location.href = result.paymentUrl;
    }
  }
};
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
npm run dev
```

### 2. è®¿é—®æ”¯ä»˜é¡µé¢

åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€: `http://localhost:3000/payment?debug=china`

### 3. é€‰æ‹©æ”¯ä»˜è®¡åˆ’

- ç‚¹å‡» "è®¢é˜…è®¡åˆ’" æ ‡ç­¾
- é€‰æ‹© "Pro Plan"
- é€‰æ‹© "Monthly" æˆ– "Yearly"

### 4. é€‰æ‹©æ”¯ä»˜æ–¹å¼

- ç‚¹å‡» "æ”¯ä»˜" æ ‡ç­¾
- é€‰æ‹© "æ”¯ä»˜å®" æ”¯ä»˜æ–¹å¼
- ç‚¹å‡» "ç«‹å³æ”¯ä»˜" æŒ‰é’®

### 5. å®Œæˆæ”¯ä»˜

- âœ… ç°åœ¨åº”è¯¥ä¼šè‡ªåŠ¨è·³è½¬åˆ°æ”¯ä»˜å®æ”¶é“¶å°
- ä½¿ç”¨æ²™ç®±ä¹°å®¶è´¦å·ç™»å½•
- ç™»å½•å¯†ç : 111111
- æ”¯ä»˜å¯†ç : 111111

### 6. éªŒè¯æ”¯ä»˜ç»“æœ

- æ”¯ä»˜æˆåŠŸåä¼šè·³è½¬åˆ° `/payment/success?out_trade_no=xxx`
- åº”è¯¥æ˜¾ç¤º "æ”¯ä»˜æˆåŠŸ" ä¿¡æ¯
- ä¼šå‘˜æ—¶é•¿åº”è¯¥è‡ªåŠ¨å»¶é•¿

## ğŸ” è°ƒè¯•ä¿¡æ¯

### æµè§ˆå™¨æ§åˆ¶å°

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)ï¼ŒæŸ¥çœ‹ Console æ ‡ç­¾:

```javascript
// åˆ›å»ºæ”¯ä»˜æ—¶çš„æ—¥å¿—
Payment success callback: {
  sessionId: null,
  token: null,
  outTradeNo: "ALIPAY_xxx"
}

// æ”¯ä»˜è¡¨å•æäº¤
Alipay API response: <form method="post" action="https://openapi-sandbox.dl.alipaydev.com/gateway.do">...
```

### ç½‘ç»œè¯·æ±‚

åœ¨ Network æ ‡ç­¾ä¸­æŸ¥çœ‹:

1. **åˆ›å»ºæ”¯ä»˜è¯·æ±‚**

   - URL: `/api/payment/onetime/create`
   - Method: POST
   - Body: `{"method":"alipay","billingCycle":"monthly"}`
   - Response: `{"success":true,"paymentId":"ALIPAY_xxx","paymentUrl":"<form..."}`

2. **æ”¯ä»˜å®ç½‘å…³è·³è½¬**

   - URL: `https://openapi-sandbox.dl.alipaydev.com/gateway.do`
   - Method: POST (è¡¨å•æäº¤)
   - Status: 302 (é‡å®šå‘åˆ°æ”¶é“¶å°)

3. **æ”¯ä»˜ç¡®è®¤è¯·æ±‚**
   - URL: `/api/payment/onetime/confirm?out_trade_no=xxx`
   - Method: GET
   - Response: `{"success":true,"transactionId":"xxx","daysAdded":30}`

## âš ï¸ å¸¸è§é—®é¢˜

### é—®é¢˜ 1: è¡¨å•æ²¡æœ‰è‡ªåŠ¨æäº¤

**åŸå› **: æµè§ˆå™¨é˜»æ­¢äº†è‡ªåŠ¨æäº¤  
**è§£å†³**: æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ï¼Œç¡®ä¿è¡¨å• HTML æ ¼å¼æ­£ç¡®

### é—®é¢˜ 2: æ”¯ä»˜å®é¡µé¢åŠ è½½å¾ˆæ…¢

**åŸå› **: æ²™ç®±ç¯å¢ƒç½‘ç»œè¾ƒæ…¢  
**è§£å†³**: è€å¿ƒç­‰å¾…ï¼Œæˆ–åˆ·æ–°é¡µé¢é‡è¯•

### é—®é¢˜ 3: ç­¾åéªŒè¯å¤±è´¥

**åŸå› **: å¯†é’¥é…ç½®ä¸æ­£ç¡®  
**è§£å†³**:

1. æ£€æŸ¥ `.env.local` ä¸­çš„å¯†é’¥é…ç½®
2. ç¡®ä¿ä½¿ç”¨ Base64 PKCS#1 æ ¼å¼
3. ç¡®ä¿æ²¡æœ‰å¤šä½™çš„ç©ºæ ¼æˆ–æ¢è¡Œ

### é—®é¢˜ 4: å›è°ƒå‚æ•°ç¼ºå¤±

**åŸå› **: æ”¯ä»˜å®å›è°ƒ URL é…ç½®é”™è¯¯  
**è§£å†³**:

1. æ£€æŸ¥ `ALIPAY_RETURN_URL` é…ç½®
2. ç¡®ä¿é…ç½®ä¸º: `http://localhost:3000/payment/success`
3. ç”Ÿäº§ç¯å¢ƒéœ€è¦ä½¿ç”¨å…¬ç½‘åŸŸå

## ğŸ“Š æ”¯ä»˜æµç¨‹å›¾

```
ç”¨æˆ·é€‰æ‹©æ”¯ä»˜å®
    â†“
å‰ç«¯è°ƒç”¨ /api/payment/onetime/create
    â†“
åç«¯åˆ›å»ºæ”¯ä»˜å®è®¢å•
    â†“
è¿”å›HTMLè¡¨å•
    â†“
å‰ç«¯æ¸²æŸ“å¹¶è‡ªåŠ¨æäº¤è¡¨å•
    â†“
æµè§ˆå™¨è·³è½¬åˆ°æ”¯ä»˜å®æ”¶é“¶å°
    â†“
ç”¨æˆ·å®Œæˆæ”¯ä»˜
    â†“
æ”¯ä»˜å®åŒæ­¥è·³è½¬: /payment/success?out_trade_no=xxx
    â†“
å‰ç«¯è°ƒç”¨ /api/payment/onetime/confirm
    â†“
åç«¯éªŒè¯ç­¾åå¹¶æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
    â†“
æ›´æ–°æ•°æ®åº“å’Œä¼šå‘˜æ—¶é•¿
    â†“
æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸé¡µé¢
```

## âœ… éªŒè¯æ¸…å•

æµ‹è¯•å®Œæˆåï¼Œè¯·éªŒè¯ä»¥ä¸‹é¡¹ç›®:

- [ ] èƒ½å¤ŸæˆåŠŸè·³è½¬åˆ°æ”¯ä»˜å®æ”¶é“¶å°
- [ ] èƒ½å¤Ÿä½¿ç”¨æ²™ç®±è´¦å·ç™»å½•
- [ ] èƒ½å¤Ÿå®Œæˆæ”¯ä»˜æµç¨‹
- [ ] æ”¯ä»˜æˆåŠŸåè·³è½¬åˆ°æˆåŠŸé¡µé¢
- [ ] ä¼šå‘˜æ—¶é•¿æ­£ç¡®å»¶é•¿
- [ ] æ•°æ®åº“ä¸­æ”¯ä»˜è®°å½•çŠ¶æ€ä¸º "completed"
- [ ] æ§åˆ¶å°æ²¡æœ‰é”™è¯¯ä¿¡æ¯

## ğŸ‰ ä¸‹ä¸€æ­¥

æ”¯ä»˜æµç¨‹æµ‹è¯•æˆåŠŸå:

1. **å®ç° Webhook**: åˆ›å»º `/api/payment/webhook/alipay` æ¥å£å¤„ç†å¼‚æ­¥é€šçŸ¥
2. **æµ‹è¯•é€€æ¬¾**: æµ‹è¯•æ”¯ä»˜å®é€€æ¬¾åŠŸèƒ½
3. **ç”Ÿäº§ç¯å¢ƒ**: æ›´æ¢ä¸ºæ­£å¼ç¯å¢ƒå¯†é’¥å’Œç½‘å…³
4. **ç›‘æ§æ—¥å¿—**: æ·»åŠ è¯¦ç»†çš„æ”¯ä»˜æ—¥å¿—è®°å½•

## ğŸ’¡ æç¤º

- **æ²™ç®±é™åˆ¶**: æ¯ç¬”æ”¯ä»˜æœ€å¤š 10000 CNY
- **è´¦å·æ•°é‡**: æ²™ç®±ä¹°å®¶è´¦å·æœ‰é™ï¼Œå»ºè®®ä»æ”¯ä»˜å®å¼€æ”¾å¹³å°è·å–
- **ç½‘ç»œè¦æ±‚**: éœ€è¦èƒ½è®¿é—®æ”¯ä»˜å®æ²™ç®±ç½‘å…³ (openapi-sandbox.dl.alipaydev.com)
- **å®‰å…¨æç¤º**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPSï¼Œå¦åˆ™æ”¯ä»˜å®ä¼šæ‹’ç»å›è°ƒ

---

**æœ€åæ›´æ–°**: 2025-01-05  
**çŠ¶æ€**: âœ… é—®é¢˜å·²è§£å†³ï¼Œå¯ä»¥æ­£å¸¸è·³è½¬
